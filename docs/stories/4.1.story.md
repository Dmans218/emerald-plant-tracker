# Story 4.1: Dynamic Vendor Management System

**Epic**: 4 - Advanced Nutrient Calculator and Vendor Management
**Status**: Draft
**Created**: 2025-01-27
**Assigned**: Development Team
**Depends On**: Story 2.2 (Touch-Optimized Data Entry and Forms)

## Story

As a cannabis cultivator and system administrator,
I want to add and manage nutrient vendors through the interface,
so that I can keep the calculator current with new products and formulations without requiring code changes.

## Acceptance Criteria

- **AC1**: Admin interface allows adding new nutrient vendors with complete product lines
- **AC2**: Vendor management includes feeding schedules, ratios, and compatibility settings
- **AC3**: New vendor data integrates with existing calculation algorithms
- **AC4**: Vendor management preserves existing nutrient data and calculations

## Integration Verification

- **IV1**: Existing vendor calculations produce identical results
- **IV2**: Current nutrient calculator interface remains functional
- **IV3**: Existing feeding schedule data maintains accuracy

## Dev Technical Guidance

### Previous Story Insights

**From Story 2.2 Implementation**:

- Mobile form components (MobileFormField, MobileSelect) successfully implemented for touch-optimized data entry
- Cannabis-specific form validation and input patterns established
- Voice input capabilities and OCR functionality available for mobile data entry
- Comprehensive mobile CSS framework available for consistent styling

### Current Nutrient Calculator Architecture

**Existing Implementation** [Source: backend/routes/nutrients.js, backend/models/nutrientData-2025.js]:

The current system uses a hybrid approach:
- **Database-driven API**: PostgreSQL tables (nutrient_brands, nutrient_products, nutrient_multipliers, nutrient_targets, nutrient_weekly_schedules)
- **Hardcoded fallback**: nutrientData-2025.js model with comprehensive vendor data
- **RESTful API**: /api/nutrients/brands and /api/nutrients/brands/:brandId endpoints
- **Frontend integration**: React Calculator component with API-driven brand loading

**Current Database Schema** [Source: backend/routes/nutrients.js analysis]:

```sql
-- Primary vendor table
nutrient_brands (
  id SERIAL PRIMARY KEY,
  brand_key VARCHAR UNIQUE,
  name VARCHAR,
  description TEXT,
  created_at TIMESTAMPTZ,
  updated_at TIMESTAMPTZ
)

-- Product definitions by growth stage
nutrient_products (
  id SERIAL PRIMARY KEY,
  brand_id INTEGER REFERENCES nutrient_brands(id),
  growth_stage VARCHAR, -- seedling, vegetative, flowering, supplements
  name VARCHAR,
  ratio DECIMAL,
  unit VARCHAR,
  is_optional BOOLEAN,
  is_flowering_only BOOLEAN,
  is_hydro_only BOOLEAN,
  is_early_growth BOOLEAN,
  week_range JSONB
)

-- Strength and watering method multipliers
nutrient_multipliers (
  id SERIAL PRIMARY KEY,
  brand_id INTEGER REFERENCES nutrient_brands(id),
  multiplier_type VARCHAR, -- 'strength' or 'watering_method'
  multiplier_key VARCHAR,
  multiplier_value DECIMAL
)

-- Target EC/TDS values
nutrient_targets (
  id SERIAL PRIMARY KEY,
  brand_id INTEGER REFERENCES nutrient_brands(id),
  growth_stage VARCHAR,
  feeding_strength VARCHAR,
  target_ec DECIMAL,
  target_tds INTEGER
)

-- Weekly feeding schedules (optional)
nutrient_weekly_schedules (
  id SERIAL PRIMARY KEY,
  brand_id INTEGER REFERENCES nutrient_brands(id),
  growth_stage VARCHAR,
  week_number INTEGER, -- 99 for flush
  product_name VARCHAR,
  ratio DECIMAL
)
```

**Current Vendor Data Structure** [Source: backend/models/nutrientData-2025.js]:

The system supports comprehensive vendor data including:
- **10 Major Brands**: General Hydroponics, Advanced Nutrients, Fox Farm, Canna, Jack's 321, MegaCrop, House & Garden, Botanicare, BioBizz, Masterblend
- **Growth Stage Products**: Seedling, vegetative, flowering, supplements
- **Strength Multipliers**: Light/Medium/Aggressive feeding levels
- **Watering Method Adjustments**: Hand-watering, drip, aeroponics, DWC, etc.
- **Target Values**: EC and TDS ranges for each stage/strength combination
- **Advanced Features**: Weekly schedules, supplement timing, compatibility flags

### Vendor Management Requirements

**Admin Interface Components Required** [Source: Epic 4 requirements]:

1. **Vendor Management Dashboard**: CRUD operations for nutrient brands
2. **Product Line Editor**: Growth stage product definition with validation
3. **Multiplier Configuration**: Strength and watering method adjustments
4. **Target Value Settings**: EC/TDS ranges for cultivation guidance
5. **Schedule Builder**: Weekly feeding schedule creation (optional)
6. **Import/Export Tools**: Bulk vendor data management
7. **Validation Engine**: Data integrity and calculation accuracy verification

### Cannabis Domain Vendor Requirements

**Professional Vendor Data Structure** [Source: docs/bmad-cannabis-domain-knowledge.md]:

- **Vendor Categories**: Hydroponic, organic, dry nutrients, liquid concentrates
- **Product Classifications**: Base nutrients, supplements, additives, pH adjusters
- **Growth Stage Specificity**: Cannabis-specific feeding schedules (18/6 veg, 12/12 flower)
- **Strain Considerations**: Indica/Sativa feeding differences, autoflower adjustments
- **Medium Compatibility**: Soil, coco, hydro, soilless specific formulations
- **Professional Terminology**: PPM, EC, pH ranges, nutrient burn prevention

**Vendor Validation Requirements**:

- **Ratio Validation**: Prevent nutrient burn with maximum safe concentrations
- **Compatibility Checks**: Ensure products don't conflict (pH adjusters, chelated nutrients)
- **Unit Conversion**: Support ml/gal, g/gal, tsp/gal, mg/L conversions
- **Stage Logic**: Prevent flowering-only products in vegetative calculations
- **Safety Limits**: Cannabis-specific EC/TDS maximum values

### Technical Implementation Architecture

**Database Migration Strategy** [Source: architecture.md database integration]:

```sql
-- Enhanced vendor management tables
CREATE TABLE vendor_categories (
  id SERIAL PRIMARY KEY,
  name VARCHAR(100) UNIQUE NOT NULL,
  description TEXT,
  created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE vendor_compatibility_rules (
  id SERIAL PRIMARY KEY,
  brand_id INTEGER REFERENCES nutrient_brands(id),
  incompatible_with INTEGER REFERENCES nutrient_brands(id),
  reason TEXT,
  created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE vendor_import_logs (
  id SERIAL PRIMARY KEY,
  brand_id INTEGER REFERENCES nutrient_brands(id),
  import_type VARCHAR(50), -- 'manual', 'csv', 'api'
  imported_by VARCHAR(100),
  import_data JSONB,
  validation_results JSONB,
  created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- Add vendor management metadata to existing tables
ALTER TABLE nutrient_brands ADD COLUMN category_id INTEGER REFERENCES vendor_categories(id);
ALTER TABLE nutrient_brands ADD COLUMN vendor_website VARCHAR(255);
ALTER TABLE nutrient_brands ADD COLUMN last_updated_by VARCHAR(100);
ALTER TABLE nutrient_brands ADD COLUMN is_active BOOLEAN DEFAULT true;
ALTER TABLE nutrient_brands ADD COLUMN validation_status VARCHAR(50) DEFAULT 'pending';
```

**API Endpoint Extensions** [Source: backend/routes/nutrients.js patterns]:

```javascript
// New vendor management endpoints
POST   /api/v2/vendors/brands           // Create new brand
PUT    /api/v2/vendors/brands/:id       // Update existing brand
DELETE /api/v2/vendors/brands/:id       // Deactivate brand
POST   /api/v2/vendors/brands/:id/products    // Add products to brand
PUT    /api/v2/vendors/brands/:id/products/:productId  // Update product
POST   /api/v2/vendors/brands/:id/validate    // Validate brand data
POST   /api/v2/vendors/import           // Bulk import vendors
GET    /api/v2/vendors/export           // Export vendor data
POST   /api/v2/vendors/duplicate/:id    // Clone existing brand
```

**Frontend Component Architecture** [Source: frontend/src structure]:

```
frontend/src/
├── pages/
│   └── VendorManagement.js           # Main vendor management page
├── components/
│   ├── vendor/                       # Vendor management components
│   │   ├── VendorDashboard.js        # Vendor overview and CRUD
│   │   ├── VendorEditor.js           # Brand creation/editing form
│   │   ├── ProductLineEditor.js      # Product management interface
│   │   ├── MultiplierEditor.js       # Strength/watering adjustments
│   │   ├── TargetValueEditor.js      # EC/TDS target configuration
│   │   ├── ScheduleBuilder.js        # Weekly schedule creation
│   │   ├── VendorValidator.js        # Data validation component
│   │   ├── ImportExportTools.js      # Bulk data management
│   │   └── VendorPreview.js          # Calculation preview/testing
│   └── forms/                        # Reuse mobile form components
│       ├── MobileFormField.js        # From Story 2.2
│       └── MobileSelect.js           # From Story 2.2
└── utils/
    ├── vendorApi.js                  # Vendor management API client
    ├── vendorValidation.js           # Client-side validation logic
    └── vendorCalculations.js         # Calculation testing utilities
```

### Integration with Existing Calculator

**Backward Compatibility Strategy** [Source: frontend/src/pages/Calculator.js]:

- **API Compatibility**: Existing /api/nutrients endpoints remain unchanged
- **Data Format Consistency**: New vendor data follows existing JSON structure
- **Calculation Preservation**: All existing calculations produce identical results
- **UI Integration**: Vendor management accessible via admin interface without disrupting user workflow

**Enhanced Calculator Features**:

- **Real-time Vendor Updates**: New vendors immediately available in calculator
- **Vendor Status Indicators**: Show active/inactive vendors with validation status
- **Enhanced Error Handling**: Graceful fallback for invalid or incomplete vendor data
- **Calculation Verification**: Built-in testing to ensure new vendors produce accurate results

### Cannabis-Specific Validation Engine

**Safety Validation Rules** [Source: cannabis cultivation best practices]:

```javascript
const cannabisValidationRules = {
  maxEC: {
    seedling: 1.2,    // Prevent nutrient burn in young plants
    vegetative: 2.0,   // Maximum safe vegetative feeding
    flowering: 2.5     // Maximum safe flowering feeding
  },
  maxTDS: {
    seedling: 600,     // PPM limit for seedlings
    vegetative: 1000,  // PPM limit for vegetative growth
    flowering: 1250    // PPM limit for flowering
  },
  ratioLimits: {
    'ml/gal': { min: 0.1, max: 50.0 },  // Liquid nutrient limits
    'g/gal': { min: 0.1, max: 10.0 },   // Dry nutrient limits
    'tsp/gal': { min: 0.1, max: 5.0 }   // Powder nutrient limits
  },
  incompatibleProducts: [
    ['CalMag', 'Sulfur'], // Calcium-sulfur precipitation
    ['Silica', 'Phosphorus'], // Silica-phosphorus binding
  ]
};
```

**Professional Cultivation Guidance**:

- **Stage Transition Warnings**: Alert when flowering nutrients used in vegetative stage
- **Medium Compatibility**: Validate hydro nutrients for soil applications
- **pH Range Enforcement**: Ensure target pH ranges match medium requirements
- **Nutrient Burn Prevention**: Automatic warnings for excessive concentration levels

### File Locations and Integration

**New File Structure** [Source: architecture.md source tree integration]:

```
backend/
├── routes/
│   └── v2/
│       └── vendors.js                # New vendor management API
├── services/
│   ├── vendorValidation.js           # Validation business logic
│   ├── vendorImportExport.js         # Bulk data operations
│   └── calculationTesting.js         # Automated calculation verification
├── models/
│   ├── vendorManagement.js           # Vendor CRUD operations
│   └── vendorValidation.js           # Data validation models
└── migrations/
    └── add-vendor-management.js      # Database schema updates

frontend/src/
├── pages/
│   └── VendorManagement.js           # Main vendor management interface
├── components/vendor/                # All vendor management components
├── utils/
│   ├── vendorApi.js                  # API client for vendor operations
│   └── vendorValidation.js           # Client-side validation
└── styles/
    └── vendor-management.css         # Vendor management styling
```

### Performance and Security Considerations

**Performance Optimization** [Source: architecture.md performance requirements]:

- **Lazy Loading**: Vendor management components loaded on-demand
- **Caching Strategy**: Redis caching for frequently accessed vendor data
- **Database Indexing**: Optimized queries for vendor search and filtering
- **Calculation Caching**: Cache complex calculations for popular vendor/stage combinations

**Security Requirements** [Source: architecture.md security integration]:

- **Admin Authentication**: Role-based access control for vendor management
- **Data Validation**: Server-side validation for all vendor data inputs
- **Audit Logging**: Track all vendor management operations with user attribution
- **Input Sanitization**: Prevent SQL injection and XSS in vendor data fields

### Testing Strategy

**Calculation Accuracy Testing**:

- **Regression Testing**: Verify all existing vendor calculations remain accurate
- **New Vendor Validation**: Automated testing for new vendor data integrity
- **Cross-Browser Testing**: Ensure vendor management works across all target browsers
- **Mobile Compatibility**: Test vendor management on tablet devices for grow room use

**Integration Testing**:

- **API Compatibility**: Ensure new vendor API doesn't break existing calculator
- **Database Integrity**: Verify foreign key relationships and data consistency
- **Performance Testing**: Ensure vendor management doesn't impact calculator performance

## Tasks / Subtasks

### Task 1: Database Schema Enhancement (AC: 1, 2)

1.1. Create vendor management database migration with enhanced schema
1.2. Add vendor categories, compatibility rules, and import logging tables
1.3. Enhance existing nutrient_brands table with management metadata
1.4. Create database indexes for optimal vendor search and filtering performance
1.5. Test schema migration with existing vendor data to ensure compatibility

### Task 2: Backend API Development (AC: 1, 2, 3)

2.1. Implement vendor management API routes (CRUD operations for brands)
2.2. Create product line management endpoints with validation
2.3. Develop multiplier and target value configuration APIs
2.4. Implement vendor validation service with cannabis-specific rules
2.5. Create import/export functionality for bulk vendor management

### Task 3: Vendor Validation Engine (AC: 3, 4)

3.1. Implement cannabis-specific validation rules for nutrient safety
3.2. Create compatibility checking for products and growth stages
3.3. Develop calculation testing framework for new vendor verification
3.4. Add automatic validation for EC/TDS ranges and ratio limits
3.5. Create validation reporting and error handling systems

### Task 4: Frontend Vendor Management Interface (AC: 1, 2)

4.1. Create VendorManagement page with dashboard overview
4.2. Implement VendorEditor component for brand creation and editing
4.3. Develop ProductLineEditor for growth stage product management
4.4. Create MultiplierEditor for strength and watering method configuration
4.5. Build TargetValueEditor for EC/TDS range management

### Task 5: Advanced Management Features (AC: 1, 2)

5.1. Implement ScheduleBuilder for weekly feeding schedule creation
5.2. Create ImportExportTools for bulk vendor data management
5.3. Develop VendorValidator component for real-time validation feedback
5.4. Add VendorPreview for calculation testing before activation
5.5. Implement vendor duplication functionality for similar brand creation

### Task 6: Calculator Integration (AC: 3, 4)

6.1. Integrate new vendor management with existing calculator API
6.2. Ensure backward compatibility with current calculator interface
6.3. Add real-time vendor status indicators in calculator brand selection
6.4. Implement enhanced error handling for invalid vendor data
6.5. Create calculation verification system for new vendors

### Task 7: Cannabis Domain Integration (AC: 2, 3)

7.1. Implement cannabis-specific product categories and classifications
7.2. Add strain-specific feeding recommendations and adjustments
7.3. Create medium-specific validation (soil, hydro, coco compatibility)
7.4. Implement professional cultivation terminology and guidance
7.5. Add nutrient burn prevention and safety warnings

### Task 8: Testing and Validation (IV: 1, 2, 3)

8.1. Perform comprehensive regression testing on existing calculations
8.2. Test new vendor creation and management workflows
8.3. Validate calculation accuracy for all vendor/stage combinations
8.4. Test mobile compatibility for vendor management interface
8.5. Perform integration testing with existing calculator functionality

## Cannabis Domain Integration

**Professional Vendor Management**:

- **Industry-Standard Validation**: EC/TDS ranges based on professional cultivation practices
- **Strain-Specific Adjustments**: Support for Indica/Sativa/Hybrid feeding differences
- **Medium Compatibility**: Soil, hydro, coco, and soilless medium validation
- **Growth Stage Logic**: Cannabis-specific vegetative and flowering stage requirements
- **Professional Terminology**: PPM, EC, pH, and nutrient timing terminology

**Cultivation Safety Features**:

- **Nutrient Burn Prevention**: Automatic warnings for excessive concentrations
- **Compatibility Checking**: Prevent incompatible product combinations
- **Stage Transition Guidance**: Proper feeding schedule transitions
- **Professional Standards**: Industry best practices for nutrient management

## Performance Targets

**Vendor Management Performance**:

- **Page Load Time**: <2 seconds for vendor management dashboard
- **Vendor Creation**: <5 seconds for new vendor save operation
- **Calculation Testing**: <3 seconds for new vendor calculation verification
- **Import Operations**: <10 seconds for bulk vendor data import
- **Database Queries**: <100ms for vendor search and filtering

## Definition of Done Checklist

- [ ] Database schema enhanced with vendor management tables and relationships
- [ ] Backend API endpoints implemented for complete vendor CRUD operations
- [ ] Vendor validation engine created with cannabis-specific safety rules
- [ ] Frontend vendor management interface created with all required components
- [ ] Import/export functionality implemented for bulk vendor management
- [ ] Calculator integration completed with backward compatibility verified
- [ ] Cannabis domain validation implemented with professional standards
- [ ] Comprehensive testing completed including regression and integration tests
- [ ] Mobile compatibility verified for vendor management interface
- [ ] Performance targets met for all vendor management operations
- [ ] Security measures implemented including admin authentication and audit logging
- [ ] Documentation completed for vendor management workflows and API endpoints

## Dev Agent Record

### Implementation Notes

*To be filled during implementation*

### Completion Notes

*To be filled during implementation*

### Debug Log References

*To be filled during implementation*

### Change Log

*To be filled during implementation*

### File List

*To be filled during implementation* 
